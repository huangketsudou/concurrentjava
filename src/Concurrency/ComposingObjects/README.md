### 对象的组合

一些组合模式，能够让一个类更容易成为线程安全的，并且在维护这些类时，不会无意破坏类的安全性标记。

#### 设计线程安全的类

基本要素：

1. 找出构成对象状态的所有变量
2. 找出约束状态变量的不变性条件
3. 建立对象状态的并发访问管理策略

##### 收集同步需求

要确保类的线程安全性，就需要确保它的不变性不会在并发访问的情况下被破坏。对象和变量都有一个状态空间，即所有可能的取值，状态空间越小或者final域越多越能简化对象可能的状态分析过程。

##### 依赖状态的操作

类的不变性条件和后验条件约束了在对象上有哪些状态和状态转换是有效的，在某些对象中还存在基于状态的鲜艳条件，如果某个操作中包含有基于状态的先验条件，那么这个操作就是依赖状态的操作。例如不能从一个空列表中移除元素，列表不为空就是移除操作的先验条件。java中等待某个条件为真的内置机制域内置加锁机制相关，可以利用阻塞队列或者信号量机制实现。

##### 状态的所有权

所有权与封装性总是相互关联的，对象封装他拥有的状态，即对它封装的状态拥有所有权。但如果发布了某个可变对象的引用，那么就意味着不在具有独占的控制权。

#### 实例封装

封装简化了线程安全类的实现过程，提供了实例封闭机制，当一个对象被封装到另一个对象中时，能够访问被封装对象的所有代码路径都是已知的。被封闭对象一定不能超过他们既定的作用域。对象可以封闭在类的一个实例（私有成员），或者某个作用域内（一个局部变量），或者封闭在线程内。

实力封装时构建线程安全类最简单的方式，可以在所策略的选择上拥有更多的灵活性。实例封闭还使得不同的状态变量可以由不同的锁1来保护。

java中类具有很多线程封闭的实例，部分类专门用于将非线程安全的类转变为线程安全的类，例如ArrayList和和HashMap可以转变为线程安全的类，例如Collections.synchronizedList，这些方法通过装饰器模式对将容器类封装在同步的包装类中，而包装器的每个方法都被实现为同步方法。

##### java监视器模式

遵循java监视器模式的对象会把对象的所有可变状态都封闭起来，并由对象自己的内置锁来保护。

java监视器模式仅是一种约定编码的约定，对于任何一种锁对象，只要自始自终都是用该所对象，都可以用来保护对象的状态。私有的对象锁可以将锁封装起来，使客户代码无法得到锁，但客户可以通过共有方法来访问锁。

#### 线程安全性的委托

大多数对象都是组合对象，当从头开始构造一个类，或者将多个非线程安全的类组合为一个类，那么java监视器模式就有用。对于本身就是线程安全的对象组合起来的类，其可能是安全的，但也有可能需要额外的措施来保证线程安全。例如之前的文件[CountingFactorizer.java](../../../src/main/java/com/jiedong/ThreadSafety/CountingFactorizer.java)，其将自身的安全性委托给了AtomicLong对象。

##### 独立的状态变量

可以将线程安全性委托给多个状态变量，只要这些变量是彼此独立的，那么组合成的类就不会在其包含的多个状态变量上增加任何的不变性条件。

CopyOnWriteArrayList是适用于管理监听器列表的线程安全的类。

##### 委托失效

对于多个线程安全的对象，其组合可能不是线程安全，原因在于这多个对象之间存在有约束条件，形成了不变性条件。对于这样的类，即其中存在非独立的状态变量，那么仅靠委托就不足以实现线程安全性。

##### 发布底层的状态变量

如果把线程安全性委托给某个对象的低层状态变量时，需要根据其添加的不变性条件决定是否可以发布。

如果一个状态变量时线程安全的，并且没有任何不变性条件来约束它的值，在变量的操作上也不存在任何不允许的状态转换，那莪就可以安全地发布这个变量。

#### 在现有的线程安全类中添加功能

现有的同步类可以提供诸如“若没有则添加”等原子操作，因此在实现线程安全类时应当优先选择继承已有的类。但是继承而得到的子类是不稳定的，原因在于如果基类改变了同步策略，那么子类也必须做出相应的更改，否则可能导致线程安全问题。

##### 客户端加载机制

当客户端不知道原始类的封装办法时，可以采取将扩展代码放入辅助类的方式实现功能拓展。但是如果采用这种方法进行安全同步，那么加锁的对象必须注意，例如文件[ListHelder.java](../../../src/main/java/com/jiedong/ComposingObjects/ListHelder.java)，unsafe方法中list被添加了锁，而方法putifAbsent被添加了另一个锁，两个不是同个锁，那么会导致list的其他操作对该方法而言不是同步的。应该采用safe方法的定义

##### 组合

采用组合方式进行加锁，可以提供统一的加锁机制保证线程安全性。

#### 同步策略文档化

在文档中说明客户端需要了解的线程安全性保证，以及代码维护人员需要了解的同步策略。



